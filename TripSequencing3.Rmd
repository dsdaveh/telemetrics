---
title: "Trip Sequencing Part 3"
author: "Dave Hurst"
date: "Monday, February 9, 2015"
output: html_document
---

Continuing the work to convert a trip into a sequence of segments.  The input will be a full trip, and the output will be broken up into several components:
- A list of segments with details (or reference to details) on each segment
- A sequence of segment ID's that comprise the trip
- A of set data for each segment type

I'm going to try to reconstruct each trip out of segments made up of the following types:  

- stops *DONE: See part 1* (no driver profile for these, but we need them to describe the segment)  
- sharp turns  *DONE: See part 2*
- curves (differentiated from sharp turns by radii (as a function of speed))  
- bends ( differentiated from curves by time < 3 data points)  
- straights  
- uncategorized:  
-- short straights (too short to collect profile info)  
-- slow rolling sections (drive thrus, driveways, etc. -- no profile info)  
-- windy sections (ideally break these up later)  
-- other?  

Same usual setup, same driver/trip 2591/49
```{r init, echo=FALSE}
library(knitr)
source("telematic_util.R")

data.dir <- "c:/NO_BACKUP/kaggle/telematics/drivers"

drivers.dir <- dir(data.dir)
set.seed(2349)

driver.id <- 2591
trip.id <- 49
trip <- getTrip( driver.id, trip.id )

#plotTripSegment(trip, 1, 99999)
```  


```{r prelim2 }
trip.seg <- segment.by.stops(trip)
trip.seg <- segment.by.turns( trip, trip.seg) 

```
`trip.seg` is now where we left it in part 2.   

```{r inspect}
segs <- trip.seg[!grepl("^x", trip.seg$type), ]
segs <- segs[ order(segs$t0),]
segs
```

Starting with a visual inspections of segment t=39:108 to come up with some rules
```{r inspect1, fig.width=10}
#plotTripSegment(trip, 39, 108, t.mark=5)
plotTripSegment(trip, 45, 65, t.mark=2)
plotTrip.r(trip,  tmin=45, tmax=65)

```

- r < 200 
- constant direction of curve
-- and back off/add a point 
-- for the example (originally) plotted here I want the curve to be defined by the sequence with R values (568,195,98,243).  The next "curve" is a bend because it only drops below 200 for one point (R=67) and then switches curvature

```{r inspect2, fig.width=10}
#plotTripSegment(trip, 39, 108, t.mark=5)
plotTripSegment(trip, 60, 90, t.mark=2)
plotTrip.r(trip,  tmin=60, tmax=90)
```

Continuing with the rules above, we get a curve defined for R values
-- 257,87,162,71,304 (right hand)
-- 171, 175,61,73,69   (left hand)
--- note: the backoff 1 doesn't work for the last one, since the curve changes direction

```{r inspect3, fig.width=10}
#plotTripSegment(trip, 39, 108, t.mark=5)
plotTripSegment(trip, 88, 115, t.mark=2)
plotTrip.r(trip,  tmin=88, tmax=115)
```

This is a gradual curve in laymans turns, but a series of bends in mine (up to now).  So I think I'm getting wrapped around the axle with trying to capture both driving behavior (i.e. its a curve if it affects their speed) and geography.  Because the behavior needs to account for connected segments ... i.e. driving behavior in an S-curve probably differs for a curve of identical radius connected by straights.   So for now I'm just going to try and capture the geographical curves.   I'll start by just capturing sequences of similar radius and lets arbitrarily say at least 4 points less than r=1000

I've implemented that using segment.by.curve.gen, and re-written segment.by.turn to use that function as well.
Here are the curve segments it finds for this trip.

```{r find.curves }
#trip.seg <- segment.by.stops(trip)
#trip.seg <- segment.by.turns( trip, trip.seg) 
trip.seg <- segment.by.curve.gen( trip, trip.seg, r.thresh=1000, t.thresh=4, ctype="curve")
segs <- trip.seg[!grepl("^x", trip.seg$type), ]
segs <- segs[ order(segs$t0),]
curves <- segs[grepl("curve",segs$type), ]
curves

```
I wrote plotTripOverlay to handle overlays of segments which should help view the data.  Since this trip doubles back on itself, I've plotted it in two parts

```{r plot.curves, fig.width=10}
   par.orig <- par(mfrow=c(1,2))
plotTrip(trip, tmax=200, header=F)
plotTripOverlay(trip, curves[1:6,])
plotTrip(trip, tmin=200, header=F)
plotTripOverlay(trip, curves[7:17,])
   par(par.orig)
```

## Functions created/used
```{r p4.func}
segment.by.curve.gen
plotTripOverlay
```
